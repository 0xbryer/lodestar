
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lodestar Documentation - Typescript Ethereum Consensus client">
      
      
      
        <link rel="canonical" href="https://chainsafe.github.io/lodestar/tools/heap-dumps/">
      
      
        <link rel="prev" href="../flamegraphs/">
      
      
        <link rel="next" href="../core-dumps/">
      
      
      <link rel="icon" href="../../assets/round-icon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>Heap Dumps - Lodestar Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extras.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="black" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#heap-dump-analysis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Lodestar Documentation" class="md-header__button md-logo" aria-label="Lodestar Documentation" data-md-component="logo">
      
  <img src="../../assets/lodestar_icon_300.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lodestar Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Heap Dumps
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="preference" data-md-color-primary="black" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/chainsafe/lodestar" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    chainsafe/lodestar
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Lodestar Documentation" class="md-nav__button md-logo" aria-label="Lodestar Documentation" data-md-component="logo">
      
  <img src="../../assets/lodestar_icon_300.png" alt="logo">

    </a>
    Lodestar Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/chainsafe/lodestar" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    chainsafe/lodestar
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/starting-a-node/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starting a Node
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-retention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Retention
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Beacon Node
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Beacon Node
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../beacon-management/beacon-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../beacon-management/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../beacon-management/mev-and-builder-integration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MEV and Builder Integration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../beacon-management/syncing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Syncing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Validator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Validator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../validator-management/validator-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bootnode
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Bootnode
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bootnode/bootnode-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Light Client and Prover
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Light Client and Prover
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lightclient-prover/lightclient/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Light Client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lightclient-prover/lightclient-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Light Client Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lightclient-prover/prover/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prover
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Logging and Metrics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Logging and Metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logging-and-metrics/prometheus-grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prometheus and Grafana
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logging-and-metrics/client-monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Client Monitoring
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../supporting-libraries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Supporting Libraries
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribution/getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribution/depgraph/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dependency Graph
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12_3" >
        
          
          <label class="md-nav__link" for="__nav_12_3" id="__nav_12_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Testing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12_3">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribution/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribution/testing/simulation-tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulation Tests
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" checked>
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flamegraphs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flame Graphs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Heap Dumps
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Heap Dumps
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#javascript-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      JavaScript Heap Dump
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JavaScript Heap Dump">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-v8-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a V8 heap dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viewing-a-v8-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Viewing a V8 heap dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyzing-a-v8-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Analyzing a V8 heap dump
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#native-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Native Heap Dump
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Native Heap Dump">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-collection-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Build collection tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collect-a-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Collect a heap dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collecting-a-heap-dump-on-a-running-process" class="md-nav__link">
    <span class="md-ellipsis">
      Collecting a heap dump on a running process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-heaptrack-gui-on-linux" class="md-nav__link">
    <span class="md-ellipsis">
      Installing heaptrack-gui on Linux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-heaptrack-gui-on-osx" class="md-nav__link">
    <span class="md-ellipsis">
      Installing heaptrack-gui on OSX
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-dumps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Dumps
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Advanced Topics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Advanced Topics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced-topics/setting-up-a-testnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setting Up a Testnet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#javascript-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      JavaScript Heap Dump
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JavaScript Heap Dump">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-v8-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a V8 heap dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viewing-a-v8-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Viewing a V8 heap dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyzing-a-v8-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Analyzing a V8 heap dump
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#native-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Native Heap Dump
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Native Heap Dump">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-collection-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Build collection tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collect-a-heap-dump" class="md-nav__link">
    <span class="md-ellipsis">
      Collect a heap dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collecting-a-heap-dump-on-a-running-process" class="md-nav__link">
    <span class="md-ellipsis">
      Collecting a heap dump on a running process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-heaptrack-gui-on-linux" class="md-nav__link">
    <span class="md-ellipsis">
      Installing heaptrack-gui on Linux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-heaptrack-gui-on-osx" class="md-nav__link">
    <span class="md-ellipsis">
      Installing heaptrack-gui on OSX
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="heap-dump-analysis">Heap Dump Analysis<a class="headerlink" href="#heap-dump-analysis" title="Permanent link">&para;</a></h1>
<p>There are a number of reason why one would want to do a heap dump but in particular, they are helpful for find memory intensive operations and leaks. There are two major types of heap dumps that are available to node developers. The first is a JavaScript heap dump, and the second is a native heap dump. The JS heap dump is much more common and is the default heap dump that is generated by <code>node</code>. It is useful when analyzing JS generated objects that are managed by the runtime. However there is one major limitation to the JS heap dump, and that is that it does not include native objects. This is where the native heap dump comes in handy. The native heap dump is a snapshot of the entire process memory, and includes objects that are allocated by <code>C/C++</code> code, including native modules in use by the application. The limitation to the native heap dump is that it will not include any JS objects that are allocated by the <code>V8</code> runtime. Those are generally created within <code>mmap</code>'ed pages and the native heap dump tools are specific to <code>C</code> objects that are created with <code>malloc</code> and destroyed via <code>free</code>. <code>C++</code> is also covered as <code>new</code> and <code>delete</code> are wrappers around <code>malloc</code> and <code>free</code>. This is why it is important to understand how to analyze both types of memory usage.</p>
<h2 id="javascript-heap-dump">JavaScript Heap Dump<a class="headerlink" href="#javascript-heap-dump" title="Permanent link">&para;</a></h2>
<p>Node has built in <code>V8</code> heap dump access and its a very powerful tool for analyzing memory usage. Understanding how the dump is created will both help to understand how it is displayed and how to use the analysis more effectively.</p>
<p>The <code>V8</code> heap dump is a stop the world process because walking the entire heap graph is necessary to create one. This is similar to a full, major garbage collection event. The VM starts at the heap entrance node and walks the entire graph and makes note of every edge that connects each node along the way. Nodes are JSObjects and edges are references between those objects.</p>
<p>By time the whole heap is walked the full size and values of all nodes are known and all of the connections between those nodes is well understood. The object that is returned is a set of three arrays, the nodes, the edges and the string values that are encountered (because strings are themselves arrays of characters in <code>C</code> so they are treated a bit differently by <code>V8</code>).</p>
<h3 id="creating-a-v8-heap-dump">Creating a <code>V8</code> heap dump<a class="headerlink" href="#creating-a-v8-heap-dump" title="Permanent link">&para;</a></h3>
<p>There are two functions for creating a heap dump but both call the same functionality under the hood. One streams the result, <code>require("v8").getHeapSnapshot([options])</code>, and is primarily intended for use by the Chrome devtools button to "take a snapshot". The second writes the heap dump to a file, <code>require("v8").writeHeapSnapshot(filename[,options])</code>.</p>
<p>The optional <code>options</code> argument, in both cases, is the same and contains two props.<code>exposeInternals</code> and <code>exposeNumericValues</code> to enrich the dump. In many cases its the application layer that one wants to debug so <code>exposeInternals</code> is not usually necessary. In <code>V8</code> numbers are stored as 32bit integers and the size of pointers is also 32bits. So as an optimization, the pointer to the numeric value can be eliminated and the value itself can be stored in the <code>Address</code> of the <code>Value</code> instead. <code>exposeNumericValues</code> transcribes those "pointers" to the actual numeric value and appends them to the dump.</p>
<p>Because heap analysis happens frequently during Lodestar development there is a helper api endpoint to capture a heap dump. <strong>It is IMPORTANT</strong> that this endpoint is not public facing as it will open the threat of DDOS attack.</p>
<p>The endpoint accepts a <code>POST</code> request and you may include an optional <code>dirpath</code> query parameter to specify the directory where the heap dump will be written. If the <code>dirpath</code> is not specified then the heap dump will be written to the current working directory.</p>
<p>To create a Lodestar heap dump you can use the following command:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9596/eth/v1/lodestar/write_heapdump?dirpath<span class="o">=</span>/some/directory/path
</code></pre></div>
<h3 id="viewing-a-v8-heap-dump">Viewing a <code>V8</code> heap dump<a class="headerlink" href="#viewing-a-v8-heap-dump" title="Permanent link">&para;</a></h3>
<p>It is best to analyze on a local development machine so if Lodestar is running on a cloud instance download the dump to the local environment. Open Chrome, or any Chromium based browser (the example photos were taken using Brave). In the url bar type <code>chrome:://inspect</code> to bring up the DevTools menu (in brave the url will be rewritten to <code>brave://inspect</code>).</p>
<p><img alt="DevTools" src="../../images/heap-dumps/devtools.png" /></p>
<p>Click on the <code>Open dedicated DevTools for Node</code> link to open the node specific window and click on the <code>Memory</code> tab as shown below.</p>
<p><img alt="Memory Tab" src="../../images/heap-dumps/memory-tab.png" /></p>
<p>Load the profile by either right clicking on the left pane or by clicking the <code>Load</code> button at the bottom.</p>
<p><img alt="Load Profile" src="../../images/heap-dumps/load-profile.png" /></p>
<h3 id="analyzing-a-v8-heap-dump">Analyzing a <code>V8</code> heap dump<a class="headerlink" href="#analyzing-a-v8-heap-dump" title="Permanent link">&para;</a></h3>
<p>Analysis is as much an art as it is a science and the best way to learn is to do it a few times. Generally the goal is looking for memory leaks but reducing memory overhead is also something that happens. This guide will focus on leaks. With memory leaks one is looking for why objects have references that prevent them from being garbage collected.</p>
<p>To spot sources of leaks, focus on objects that have large quantities or very large <code>retained size</code>. Retained size is the amount of memory that would be freed if the object was garbage collected. As an example if there is an object that has lots and lots of instances, like 100,000, and they are all pushed into an array then the array will have a very large retained size. This is because the array is holding references to all of the objects that it contains.</p>
<!-- TODO: (matthewkeil) add this image -->
<!-- ![Retained Size](./images/heap-dumps/retained-size.png) -->

<p>If it is not immediately apparent what objects are being leaked then another tool in your arsenal will be to take a second snapshot and compare it to the first. This will show what objects have been created/changed since the first snapshot.</p>
<p>If there is an object that has a large retained size but is roughly the same, but not exactly the same, changes are that is NOT the leak. Some objects can get quite large during runtime but if its roughly the same size over time, but not exactly the same, it means that the application is modifying the object (why its not exactly identical in size) but if it hasn't grown significantly over time it can be assumed it is probably the working size of the instances.</p>
<p>Try to focus on objects that are growing in size or in number over time. Growing in size means the object is holding references to other objects and growing in number means a function closure somewhere is retaining the small instances.</p>
<!-- TODO: (matthewkeil) add this image -->
<!-- ![Comparison](./images/heap-dumps/comparison.png) -->

<p>That is the science part, but these clues are just breadcrumbs to follow. In order to actually resolve the leak, one needs to go into the code to figure out where those objects are being created, or more often, why the references to them are being retained. This is where the art comes in.</p>
<p>Having a good understanding of the codebase will help to narrow down where to look. It is also common that the leak is not coming directly from Lodestar code, but rather one of the dependencies so be careful not to rule those out.</p>
<h2 id="native-heap-dump">Native Heap Dump<a class="headerlink" href="#native-heap-dump" title="Permanent link">&para;</a></h2>
<p><em><strong>note: collecting a native heap dump is only supported on linux, analysis can be done from linux or Mac</strong></em></p>
<p>There are several tools that can be used to do native heap dump analysis. The most common are <a href="https://valgrind.org/docs/manual/ms-manual.html"><code>massif</code></a> from the <a href="https://valgrind.org/"><code>Valgrind</code></a> suite, google's <a href="https://github.com/gperftools/gperftools"><code>gperftools</code></a> and <code>heaptrack</code> from <a href="https://community.kde.org/Main_Page">KDE</a>. Of the three, <code>heaptrack</code> is the most user friendly tool, and it is specifically designed for the task. It is much faster than <code>Valgrind</code>, easier to integrate than <code>gperftools</code> and also includes a gui for result analysis. Often times there are also memory allocations that are not related to memory leaks, and tools like <code>Valgrind</code> and <code>gperftools</code> become less useful. This is why <code>heaptrack</code> is the recommended tool for heap dump analysis on Lodestar.</p>
<p>There are a few things that will make the results with <code>heaptrack</code> far better. The most important is using debug builds of all libraries included in a binary, including the application itself. This will make the results usable. Not to say that they will be useless without debug symbols but it will be kinda tough to optimize functions without knowing the function names nor the file and line numbers.</p>
<p>This is the heart of what <code>heaptrack</code> will do for us. It hooks into the memory allocation and adds in stack traces for each <code>malloc</code> call site. That way every time memory is reserved there is a way to track back where it happened in the code. <code>heaptrack</code> also hooks into the <code>free</code> function and checks that versus the allocations to check for memory leaks and for temporary variables that can be optimized. This also allows for optimization of how many of each object is created by identifying high frequency allocations.</p>
<p>Generally the .heapdump file will be created on a cloud server and then copied to a local machine for analysis, mostly because the gui is not available through ssh. The gui is not required for analysis but it is much easier to use than the command line tools. The first step will be to install <code>heaptrack</code> on the target server and to capture a profile.</p>
<h3 id="build-collection-tools">Build collection tools<a class="headerlink" href="#build-collection-tools" title="Permanent link">&para;</a></h3>
<p>Assume the following directory structure:</p>
<div class="highlight"><pre><span></span><code>├──<span class="w"> </span>beacon-node
│<span class="w">   </span>├──<span class="w"> </span>db
│<span class="w">   </span>├──<span class="w"> </span>logs
│<span class="w">   </span>├──<span class="w"> </span>start-lodestar.sh
│<span class="w">   </span>└──<span class="w"> </span>rc-config.yml
├──<span class="w"> </span>lodestar
└──<span class="w"> </span>node<span class="w"> </span><span class="c1"># step below will clone this repo</span>
</code></pre></div>
<p>We will start from the directory that contains <code>lodestar</code> and the <code>beacon-node</code> files.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Install heaptrack</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>heaptrack

<span class="c1"># Using a debug build of node is recommended and it can be build</span>
<span class="c1"># from source. Clone the node repo to get started.</span>
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/nodejs/node.git
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>node

<span class="c1"># Use whichever version of node you prefer</span>
$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>v20.10.0
$<span class="w"> </span>./configure<span class="w"> </span>--debug

<span class="c1"># This command only builds the debug version of node and assumes</span>
<span class="c1"># that a release version of node is already installed on the system</span>
$<span class="w"> </span>make<span class="w"> </span>-C<span class="w"> </span>out<span class="w"> </span><span class="nv">BUILDTYPE</span><span class="o">=</span>Debug<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="w"> </span>--all<span class="k">)</span>

<span class="c1"># Move the debug version of node the the same folder that the release</span>
<span class="c1"># version is installed in and name it `node_debug`.  This will put the</span>
<span class="c1"># debug binary on the path and allow you to run it with the</span>
<span class="c1"># `node_debug` command</span>
$<span class="w"> </span>cp<span class="w"> </span>out/Debug/node<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>which<span class="w"> </span>node<span class="k">)</span><span class="s2">_debug&quot;</span>
$<span class="w"> </span>which<span class="w"> </span>node_debug
/your/home/directory/.nvm/versions/node/v20.10.0/bin/node_debug

<span class="c1"># Return to the lodestar repo</span>
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>../lodestar

<span class="c1"># Clean the build artifacts and node_modules</span>
$<span class="w"> </span>yarn<span class="w"> </span>clean<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>yarn<span class="w"> </span>clean:nm

<span class="c1"># Install the dependencies</span>
$<span class="w"> </span>yarn<span class="w"> </span>install

<span class="c1"># Ensure that all native modules are rebuilt with debug symbols. Some</span>
<span class="c1"># modules are prebuilt, like classic-level, and the debug symbols may</span>
<span class="c1"># not be included. If the the debugging exercise is focussed around</span>
<span class="c1"># one of these dependencies, then you will need to manually clone those</span>
<span class="c1"># repos and manually build them with debug symbols.</span>
$<span class="w"> </span>npm<span class="w"> </span>rebuild<span class="w"> </span>--debug
</code></pre></div>
<h3 id="collect-a-heap-dump">Collect a heap dump<a class="headerlink" href="#collect-a-heap-dump" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Move to th `beacon-node` directory</span>
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>../beacon-node

<span class="c1"># Start lodestar with profiling enabled</span>
$<span class="w"> </span>heaptrack<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>--output<span class="w"> </span>./lodestar.heapdump<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>node_debug<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>--max-old-space-size<span class="o">=</span><span class="m">8192</span><span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>../lodestar/packages/cli/bin/lodestar.js<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>beacon<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>--rcConfig<span class="w"> </span>./rc-config.yml<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">&amp;</span>
<span class="c1"># Wait some period of time for the heap dump data to be collected</span>

<span class="c1"># The data will not be persisted until the process is stopped. You can gracefully</span>
<span class="c1"># stop the process with the following command and if you want to hard kill it</span>
<span class="c1"># add `-9` to the end of the `kill` command although that should not be necessary</span>
$<span class="w"> </span>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>lodestar<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>grep<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span><span class="nb">kill</span>
</code></pre></div>
<h3 id="collecting-a-heap-dump-on-a-running-process">Collecting a heap dump on a running process<a class="headerlink" href="#collecting-a-heap-dump-on-a-running-process" title="Permanent link">&para;</a></h3>
<p>Collecting a heap dump can also be done on a running process. There are both advantages and disadvantages to this approach. The main advantage is that you can collect a heap dump without having to restart. The down side is that the dump will only include allocations/de-allocations while the tracker is running. This means that all the non-paired calls to malloc/free will register as leaks. It will also not give a true representation of how the heap is being used. On the upside, however the dump will be much smaller in size.</p>
<p>It is important to note a warning that is in the <code>heaptrack</code> source code:</p>
<p><em>WARNING: Runtime-attaching heaptrack is UNSTABLE and can lead to CRASHES in your application, especially after you detach heaptrack again. You are hereby warned, use it at your own risk!</em></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Move to th `beacon-node` directory</span>
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>../beacon-node

<span class="c1"># Start lodestar</span>
$<span class="w"> </span>node_debug<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>--max-old-space-size<span class="o">=</span><span class="m">8192</span><span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>../lodestar/packages/cli/bin/lodestar.js<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>beacon<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>--rcConfig<span class="w"> </span>./rc-config.yml<span class="w"> </span><span class="se">\</span>
$<span class="w">   </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">&amp;</span>
<span class="c1"># Wait some period of time to start collecting the dump</span>

<span class="c1"># GDB is required to inject heaptrack into a running process</span>
<span class="c1"># so you may need to install it</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>gdb

<span class="c1"># Elevated `perf` permissions are also required depending on your</span>
<span class="c1"># system configuration. Change until the next reboot</span>
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/kernel/yama/ptrace_scope

<span class="c1"># Get the pid of the lodestar process</span>
$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">LODESTAR_PID</span><span class="o">=</span><span class="k">$(</span>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>lodestar<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>grep<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>

<span class="c1"># Inject heaptrack into the running process</span>
$<span class="w"> </span>heaptrack<span class="w"> </span>--pid<span class="w"> </span><span class="nv">$LODESTAR_PID</span>

heaptrack<span class="w"> </span>output<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>written<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;/home/user/beacon-node/heaptrack.node_debug.111868.zst&quot;</span>
/usr/lib/heaptrack/libheaptrack_preload.so
injecting<span class="w"> </span>heaptrack<span class="w"> </span>into<span class="w"> </span>application<span class="w"> </span>via<span class="w"> </span>GDB,<span class="w"> </span>this<span class="w"> </span>might<span class="w"> </span>take<span class="w"> </span>some<span class="w"> </span>time...
injection<span class="w"> </span>finished
<span class="c1"># Wait some period of time to collect the heap dump. See below</span>
<span class="c1"># for the termination command that can be run from a separate</span>
<span class="c1"># terminal when ready to stop collecting data</span>
Terminated
removing<span class="w"> </span>heaptrack<span class="w"> </span>injection<span class="w"> </span>via<span class="w"> </span>GDB,<span class="w"> </span>this<span class="w"> </span>might<span class="w"> </span>take<span class="w"> </span>some<span class="w"> </span>time...
Heaptrack<span class="w"> </span>finished!<span class="w"> </span>Now<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>to<span class="w"> </span>investigate<span class="w"> </span>the<span class="w"> </span>data:

<span class="w">  </span>heaptrack<span class="w"> </span>--analyze<span class="w"> </span><span class="s2">&quot;/home/user/beacon-node/heaptrack.node_debug.111868.zst&quot;</span>
</code></pre></div>
<p>There is a trap in <code>heaptrack</code> but the process uses a nested shell to do the actual injection so it is not possible to just Ctrl+C out of the injected process without corrupting the output file. To properly kill the collection one needs to target the nested shell pid. Here is a helper command to target that process:</p>
<div class="highlight"><pre><span></span><code>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;[h]eaptrack --pid&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;$3 == &#39;</span><span class="k">$(</span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;[h]eaptrack --pid&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;$3 != 1 {print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span><span class="s1">&#39; {print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-r<span class="w"> </span><span class="nb">kill</span>
</code></pre></div>
<p>After working with the injected process for a while, I cannot honestly recommend it. It can work in a pinch, and is best suited for when the profiled process can be exited gracefully without repercussions (not on mainnet for instance). The benefit, though, is that the heapdump will be much smaller and targeted to runtime (will not have the transient, startup allocations) which can make it easier to see what is happening.</p>
<h3 id="installing-heaptrack-gui-on-linux">Installing <code>heaptrack-gui</code> on Linux<a class="headerlink" href="#installing-heaptrack-gui-on-linux" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># You can you apt, apt-get or aptitude to install the gui</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>heaptrack-gui
</code></pre></div>
<h3 id="installing-heaptrack-gui-on-osx">Installing <code>heaptrack-gui</code> on OSX<a class="headerlink" href="#installing-heaptrack-gui-on-osx" title="Permanent link">&para;</a></h3>
<p>At the time of writing this there is no official pre-built binary for OSX. This was a bit of a challenge but it was WELL worth the effort as the tool works very well. There were a number of bugs along the way while "using the docs" so your mileage may vary, but this is what worked for me.</p>
<p>Most of the dependencies can be installed via Homebrew and the tool itself needs to be built from source. There was one dependency that needed to be built from source. This process assumes a working folder that the repos can be cloned into.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Start in the root folder where the repos will be cloned</span>
$<span class="w"> </span>brew<span class="w"> </span>install<span class="w"> </span>qt@5

<span class="c1"># prepare tap of kde-mac/kde</span>
$<span class="w"> </span>brew<span class="w"> </span>tap<span class="w"> </span>kde-mac/kde<span class="w"> </span>https://invent.kde.org/packaging/homebrew-kde.git
$<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>brew<span class="w"> </span>--repo<span class="w"> </span>kde-mac/kde<span class="k">)</span><span class="s2">/tools/do-caveats.sh&quot;</span>

<span class="c1"># install the kde-mac and other required dependencies</span>
$<span class="w"> </span>brew<span class="w"> </span>install<span class="w"> </span>kde-mac/kde/kf5-kcoreaddons<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>kde-mac/kde/kf5-kitemmodels<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>kde-mac/kde/kf5-kconfigwidgets<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>kde-mac/kde/kdiagram<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>extra-cmake-modules<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>ki18n<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>threadweaver<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>boost<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>zstd<span class="w"> </span><span class="se">\</span>
$<span class="w">     </span>gettext

<span class="c1"># There is a bug in the current version of kde-mac/kde and one dependency needs</span>
<span class="c1"># to be built manually. This is the workaround to get it built.</span>
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://invent.kde.org/frameworks/kio.git
$<span class="w"> </span>mkdir<span class="w"> </span>kio/build
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>kio/build
$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">CMAKE_PREFIX_PATH</span><span class="o">=</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="w"> </span>qt@5<span class="k">)</span>
$<span class="w"> </span>cmake<span class="w"> </span>-G<span class="w"> </span>Ninja<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>..
$<span class="w"> </span>ninja
$<span class="w"> </span>sudo<span class="w"> </span>ninja<span class="w"> </span>install
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>../..

<span class="c1"># Now make sure that the dependencies are available to the system during runtime</span>
$<span class="w"> </span>ln<span class="w"> </span>-sfv<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="k">)</span><span class="s2">/share/kf5&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/Library/Application Support&quot;</span>
$<span class="w"> </span>ln<span class="w"> </span>-sfv<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="k">)</span><span class="s2">/share/knotifications5&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/Library/Application Support&quot;</span>
$<span class="w"> </span>ln<span class="w"> </span>-sfv<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="k">)</span><span class="s2">/share/kservices5&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/Library/Application Support&quot;</span>
$<span class="w"> </span>ln<span class="w"> </span>-sfv<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="k">)</span><span class="s2">/share/kservicetypes5&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/Library/Application Support&quot;</span>

<span class="c1"># We are now ready to build the heaptrack_gui binaries for analysis on OSX</span>
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://invent.kde.org/sdk/heaptrack.git
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>heaptrack
$<span class="w"> </span>mkdir<span class="w"> </span>build
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build
$<span class="w"> </span><span class="nv">CMAKE_PREFIX_PATH</span><span class="o">=</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="w"> </span>qt@5<span class="k">)</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/homebrew/opt/gettext/bin<span class="w"> </span>cmake<span class="w"> </span>..
$<span class="w"> </span>cmake<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>..
$<span class="w"> </span>make<span class="w"> </span>heaptrack_gui
$<span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="c1"># You can now find heaptrack_gui with your gui Applications. It is default</span>
<span class="c1"># placed as /Applications/KDE/heaptrack_gui.app</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ChainSafe/lodestar" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/lodestar_eth" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://discord.gg/yjyvFRP" target="_blank" rel="noopener" title="discord.gg" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://blog.chainsafe.io" target="_blank" rel="noopener" title="blog.chainsafe.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M180.5 74.262C80.813 74.262 0 155.633 0 256s80.819 181.738 180.5 181.738S361 356.373 361 256 280.191 74.262 180.5 74.262Zm288.25 10.646c-49.845 0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559c0-94.503-40.4-171.095-90.248-171.095Zm139.506 17.821c-17.526 0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>